# ClickSprite 金鑰系統 - 多人同時存取測試指南

## 概述

本文檔說明如何使用提供的測試工具來模擬多人同時存取 ClickSprite 金鑰系統，評估系統在並發環境下的穩定性和性能表現。

## 測試工具

### 1. concurrency-test.html
- **功能**: 網頁版多人同時存取測試工具
- **用途**: 提供直觀的測試介面，支援即時監控和結果分析
- **特色**: 
  - 圖形化測試控制面板
  - 即時統計資料顯示
  - 多種測試場景
  - 詳細的測試日誌

### 2. load-test-script.js
- **功能**: 程式化負載測試腳本
- **用途**: 可程式化控制的負載測試，支援自定義測試參數
- **特色**:
  - 靈活的測試配置
  - 詳細的性能分析
  - 自動化測試報告生成
  - 錯誤統計和建議

## 測試場景

### 1. 金鑰生成測試
- **目的**: 測試多人同時請求生成金鑰的系統表現
- **關注點**: 
  - Google Sheets API 的並發處理能力
  - 防濫用機制的有效性
  - 金鑰生成的唯一性

### 2. 金鑰驗證測試
- **目的**: 測試多人同時驗證金鑰的系統表現
- **關注點**:
  - 金鑰驗證的準確性
  - 並發驗證的資料一致性
  - 防重複使用的機制

### 3. Google Sheets 存取測試
- **目的**: 測試 Google Sheets API 的並發存取能力
- **關注點**:
  - API 請求限制
  - 資料讀寫的一致性
  - 錯誤處理機制

### 4. 防濫用機制測試
- **目的**: 測試防濫用系統在高並發下的表現
- **關注點**:
  - 每日限制的有效性
  - 每小時限制的準確性
  - 異常行為檢測

## 使用方法

### 網頁版測試工具

1. **開啟測試頁面**
   ```
   在瀏覽器中開啟 concurrency-test.html
   ```

2. **設定測試參數**
   - 模擬用戶數量: 建議從 5-10 開始
   - 請求間隔: 建議設定為 100-500ms
   - 測試持續時間: 建議設定為 30-60 秒

3. **執行測試**
   - 點擊「開始測試」按鈕
   - 觀察即時統計資料
   - 監控測試進度

4. **分析結果**
   - 查看測試摘要
   - 分析錯誤統計
   - 檢查回應時間分佈

### 程式化測試腳本

```javascript
// 基本使用範例
const loadTestRunner = new LoadTestRunner();

// 執行輕量級測試
loadTestRunner.runLoadTest({
    userCount: 5,
    requestDelay: 200,
    testDuration: 10000, // 10秒
    testType: 'mixed'
});

// 監控測試進度
const interval = setInterval(() => {
    const stats = loadTestRunner.getStats();
    console.log('測試統計:', stats);
    
    if (!stats.isRunning) {
        clearInterval(interval);
    }
}, 1000);
```

## 測試參數建議

### 輕量級測試
- 用戶數量: 5-10
- 請求間隔: 200-500ms
- 測試時間: 10-30秒
- 適用於: 日常功能驗證

### 中等負載測試
- 用戶數量: 20-50
- 請求間隔: 100-300ms
- 測試時間: 30-60秒
- 適用於: 性能基準測試

### 高負載測試
- 用戶數量: 50-100
- 請求間隔: 50-200ms
- 測試時間: 60-120秒
- 適用於: 系統極限測試

## 關鍵指標

### 性能指標
- **成功率**: 應該保持在 90% 以上
- **平均回應時間**: 應該低於 5 秒
- **最大並發用戶數**: 記錄系統能處理的最大並發數
- **錯誤率**: 應該低於 10%

### 穩定性指標
- **資料一致性**: 金鑰不應重複生成
- **防濫用有效性**: 限制機制應該正常運作
- **錯誤處理**: 異常情況應該被正確處理

## 常見問題分析

### 1. Google Sheets API 限制
- **問題**: 請求頻率超過限制
- **症狀**: 大量 429 錯誤
- **解決**: 增加請求間隔，實作重試機制

### 2. 金鑰重複生成
- **問題**: 並發請求導致重複金鑰
- **症狀**: 相同的金鑰被多次生成
- **解決**: 實作原子性操作，增加唯一性檢查

### 3. 防濫用機制失效
- **問題**: 並發請求繞過限制檢查
- **症狀**: 超過每日/每小時限制
- **解決**: 實作分散式鎖定機制

### 4. 回應時間過長
- **問題**: 系統負載過高
- **症狀**: 平均回應時間超過 5 秒
- **解決**: 優化 API 調用，增加快取機制

## 測試報告解讀

### 成功標準
- 成功率 ≥ 90%
- 平均回應時間 ≤ 5 秒
- 錯誤率 ≤ 10%
- 資料一致性 = 100%

### 警告標準
- 成功率 70-90%
- 平均回應時間 5-10 秒
- 錯誤率 10-20%

### 失敗標準
- 成功率 < 70%
- 平均回應時間 > 10 秒
- 錯誤率 > 20%

## 優化建議

### 短期優化
1. **增加請求間隔**: 減少 API 請求頻率
2. **實作重試機制**: 處理暫時性錯誤
3. **優化錯誤處理**: 提供更好的錯誤訊息

### 長期優化
1. **實作快取機制**: 減少重複的 API 調用
2. **分散式鎖定**: 防止並發衝突
3. **請求佇列**: 管理高並發請求
4. **監控和告警**: 即時監控系統狀態

## 注意事項

1. **測試環境**: 確保在測試環境中進行，避免影響生產系統
2. **API 配額**: 注意 Google Sheets API 的配額限制
3. **測試時間**: 避免在業務高峰期進行高負載測試
4. **資料清理**: 測試完成後清理測試資料

## 故障排除

### 測試無法啟動
- 檢查瀏覽器控制台錯誤
- 確認 Google Sheets API 可用性
- 檢查網路連線

### 測試結果異常
- 檢查 Google Apps Script 部署狀態
- 確認 API 權限設定
- 查看詳細錯誤日誌

### 性能問題
- 檢查 Google Sheets 檔案大小
- 確認 Apps Script 執行配額
- 分析網路延遲

## 聯繫支援

如果在測試過程中遇到問題，請：
1. 收集詳細的錯誤日誌
2. 記錄測試參數和環境資訊
3. 提供測試報告和截圖
4. 聯繫技術支援團隊
